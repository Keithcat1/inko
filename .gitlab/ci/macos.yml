---
.macos-tags:
  tags:
    - macos
    - inko
    - vbox

test:compiler:macos:
  extends:
    - .only-source-repository
    - .macos-tags
  stage: test
  before_script:
    - cd compiler
    - ruby --version
    - gem --version
    - bundle --version
    - bundle config set path vendor
    - bundle install --retry=3
  script:
    - gmake test
  cache:
    key: macos-compiler
    paths:
      - compiler/vendor/ruby

test:ivm:macos:
  extends:
    - .only-source-repository
    - .macos-tags
  stage: test
  before_script:
    - cd vm
    - rustc --version
    - cargo --version
  script:
    - env LLVM_CONFIG_PATH="$(brew --prefix llvm)/bin/llvm-config" gmake test
  cache:
    key: macos-vm
    paths:
      - .cargo
      - vm/target

test:runtime:macos:
  extends:
    - .only-source-repository
    - .macos-tags
  stage: test-runtime
  before_script:
    - ruby --version
    - rustc --version
    - cargo --version
  script:
    - env LLVM_CONFIG_PATH="$(brew --prefix llvm)/bin/llvm-config" gmake -C vm release
    - env RUBYLIB=./compiler/lib ./compiler/bin/inko-test -d runtime --vm ./vm/target/release/ivm
  cache:
    key: macos-vm
    paths:
      - .cargo
      - vm/target
  needs:
    - test:compiler:macos
    - test:ivm:macos

release:compiled:macos:
  extends:
    - .only-source-repository
    - .macos-tags
  stage: release
  before_script:
    - ruby --version
    - rustc --version
    - cargo --version
    - aws --version
  script:
    - env LLVM_CONFIG_PATH="$(brew --prefix llvm)/bin/llvm-config"
      gmake release-compiled SHA256SUM=gsha256sum
  only:
    - tags
  cache:
    key: macos-vm
    paths:
      - .cargo
      - vm/target
  needs:
    - test:runtime:macos
